<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Мобильное меню — fail-safe</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --hdr-h:56px;--bg:#ffffff;--text:#111111;--muted:#6b7280;
      --border:#e5e7eb;--overlay:rgba(0,0,0,.42);--brand:#111827
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--text);background:var(--bg)}
    a{color:var(--text);text-decoration:none}
    .sr-only{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}
    body.nav-open{overflow:hidden}

    /* Header */
    .site-header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);z-index:50}
    .site-header__inner{height:var(--hdr-h);display:flex;align-items:center;justify-content:space-between;padding:0 14px}
    .logo{display:flex;align-items:center;gap:10px;text-decoration:none;font-weight:700}
    .logo-dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .header-actions{display:flex;align-items:center;gap:8px}
    .btn-call,.btn-menu,.nav-close,.nav-back{appearance:none;border:0;background:#f3f4f6;border-radius:12px;padding:10px 12px;font-size:16px;line-height:1}
    .btn-menu{display:inline-flex;align-items:center;justify-content:center;width:42px;height:42px}
    .btn-menu__bars{width:18px;height:2px;background:currentColor;position:relative;display:block}
    .btn-menu__bars::before,.btn-menu__bars::after{content:"";position:absolute;left:0;right:0;height:2px;background:currentColor}
    .btn-menu__bars::before{top:-6px}.btn-menu__bars::after{top:6px}

    /* Overlay + mobile nav */
    .nav-overlay{position:fixed;inset:0;background:var(--overlay);opacity:0;visibility:hidden;transition:opacity .2s ease;z-index:60}
    .nav-open .nav-overlay{opacity:1;visibility:visible}

    .mobile-nav{
      position:fixed;inset:0 0 0 auto;width:min(100%,420px);background:var(--bg);
      transform:translateX(100%);transition:transform .2s ease;z-index:70;
      display:flex;flex-direction:column;
      height:100vh; /* base */
      height:100dvh; /* modern */
      max-height:100dvh;
      border-radius:16px 0 0 16px;
    }
    @supports (-webkit-touch-callout: none){
      .mobile-nav{height:-webkit-fill-available;max-height:-webkit-fill-available;}
    }
    .nav-open .mobile-nav{transform:translateX(0)}
    .mobile-nav[aria-hidden="true"]{pointer-events:none}

    .mobile-nav__header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border)}
    .mobile-nav__title{font-weight:600}
    .nav-back[hidden]{display:none}

    .mobile-nav__scroller{position:relative;overflow:hidden;flex:1;min-height:0;background:var(--bg);}

    /* FAIL-SAFE PANELS (no transforms, no opacity; show/hide via [hidden]) */
    .nav-panel{list-style:none;margin:0;padding:8px 8px 24px;height:100%;overflow:auto;background:var(--bg);color:var(--text);}
    .nav-panel[hidden]{display:none !important;}
    .nav-panel li{border-bottom:1px solid var(--border)}
    .nav-panel a,.nav-next{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 10px 14px 14px;text-decoration:none;color:var(--text);
      width:100%;background:none;border:0;font-size:16px
    }
    .nav-next::after{content:"›";font-size:20px;color:var(--muted)}
    .nav-panel a:active,.nav-next:active{background:#f3f4f6}

    /* Demo */
    .container{max-width:960px;margin:24px auto;padding:0 16px}
    h1{font-size:28px;margin:12px 0 8px}
    .lead{color:var(--muted);margin:0 0 16px}
    .card{border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:12px}
    footer{border-top:1px solid var(--border);padding:20px 16px;color:var(--muted);text-align:center;margin-top:28px}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="site-header">
    <div class="site-header__inner">
      <a class="logo" href="/"><span class="logo-dot"></span><span>Школа Бизнес-Психологии</span></a>
      <div class="header-actions">
        <a class="btn-call" href="tel:+79990000000" aria-label="Позвонить">☎</a>
        <button class="btn-menu" aria-haspopup="dialog" aria-controls="mobileNav" aria-expanded="false">
          <span class="btn-menu__bars" aria-hidden="true"></span><span class="sr-only">Открыть меню</span>
        </button>
      </div>
    </div>
  </header>

  <!-- OVERLAY + NAV -->
  <div class="nav-overlay" data-close></div>
  <aside id="mobileNav" class="mobile-nav" role="dialog" aria-modal="true" aria-label="Мобильное меню" aria-hidden="true">
    <div class="mobile-nav__header">
      <button class="nav-back" type="button" aria-label="Назад" hidden>← Назад</button>
      <div class="mobile-nav__title">Меню</div>
      <button class="nav-close" type="button" aria-label="Закрыть меню">✕</button>
    </div>

    <nav class="mobile-nav__scroller" aria-label="Основная навигация">
      <!-- ROOT (6 пунктов) -->
      <ul class="nav-panel" data-level="0" data-title="Меню" id="root">
        <li><a href="/">Главная</a></li>
        <li><button class="nav-next" data-target="#about">О Школе</button></li>
        <li><button class="nav-next" data-target="#programs">Программы</button></li>
        <li><a href="/schedule">Расписание</a></li>
        <li><button class="nav-next" data-target="#consulting">Консультирование</button></li>
        <li><button class="nav-next" data-target="#publications">Публикации</button></li>
      </ul>

      <!-- О Школе -->
      <ul class="nav-panel" id="about" data-level="1" data-title="О Школе" hidden>
        <li><a href="/about/mission">Миссия, Цели, Задачи</a></li>
        <li><a href="/about/audience">Аудитория</a></li>
        <li><a href="/about/theory">Теория и методика</a></li>
        <li><a href="/about/ontopsychology">Интегральная онтопсихология</a></li>
        <li><a href="/about/principles">Принципы (Наши приоритеты)</a></li>
        <li><a href="/about/founders">Основатели</a></li>
        <li><a href="/about/teachers">Преподаватели</a></li>
        <li><a href="/about/docs">Сведения об образовательной организации</a></li>
      </ul>

      <!-- Программы -->
      <ul class="nav-panel" id="programs" data-level="1" data-title="Программы" hidden>
        <li><button class="nav-next" data-target="#bp">Школа бизнес-психологии</button></li>
        <li><button class="nav-next" data-target="#io">Школа интегральной онтопсихологии</button></li>
        <li><button class="nav-next" data-target="#leader">Школа лидерства</button></li>
      </ul>

      <!-- Программы → Школа бизнес-психологии -->
      <ul class="nav-panel" id="bp" data-level="2" data-title="Школа бизнес-психологии" hidden>
        <li><a href="/programs/bp/integral-business">Интегральная онтопсихология в практике бизнеса.</a></li>
        <li><a href="/programs/bp/forma-mentis">Forma mentis предпринимателя: ключевые факторы успеха.</a></li>
      </ul>

      <!-- Программы → Школа интегральной онтопсихологии -->
      <ul class="nav-panel" id="io" data-level="2" data-title="Школа интегральной онтопсихологии" hidden>
        <li><a href="/programs/io/theory-and-practice">Интегральная онтопсихология: теория и практика.</a></li>
      </ul>

      <!-- Программы → Школа лидерства -->
      <ul class="nav-panel" id="leader" data-level="2" data-title="Школа лидерства" hidden>
        <li><a href="/programs/leader/metaphysics">«Метафизика и практика лидерства»</a></li>
      </ul>

      <!-- Консультирование -->
      <ul class="nav-panel" id="consulting" data-level="1" data-title="Консультирование" hidden>
        <li><a href="/consult/individual">Индивидуальное консультирование и коучинг</a></li>
        <li><a href="/consult/management">Управленческий консалтинг и трекинг</a></li>
        <li><a href="/consult/corporate">Развивающие корпоративные мероприятия</a></li>
      </ul>

      <!-- Публикации -->
      <ul class="nav-panel" id="publications" data-level="1" data-title="Публикации" hidden>
        <li><a href="/news">Новости</a></li>
        <li><a href="/articles">Статьи</a></li>
        <li><a href="/research">Исследования</a></li>
      </ul>
    </nav>
  </aside>

  <!-- DEMO -->
  <main class="container">
    <h1>Демо-контент</h1>
    <p class="lead">Fail‑safe версия без анимаций. Проверьте переходы и «Назад».</p>
    <div class="card">Если всё ок — вернём плавные анимации.</div>
  </main>

  <footer>© 2025</footer>

  <script>
    (function(){
      const body=document.body;
      const btnMenu=document.querySelector('.btn-menu');
      const aside=document.getElementById('mobileNav');
      const overlay=document.querySelector('.nav-overlay');
      const btnClose=aside.querySelector('.nav-close');
      const btnBack=aside.querySelector('.nav-back');
      const title=aside.querySelector('.mobile-nav__title');
      const panels=[...aside.querySelectorAll('.nav-panel')];
      const root=document.getElementById('root');
      let stack=[root], lastFocused=null;

      function show(panel){
        panels.forEach(p=> p.hidden = (p!==panel));
        title.textContent = panel.dataset.title || 'Меню';
        btnBack.hidden = (panel === root);
      }

      function openNav(){
        lastFocused=document.activeElement;
        body.classList.add('nav-open');
        aside.setAttribute('aria-hidden','false');
        btnMenu.setAttribute('aria-expanded','true');
        show(stack[stack.length-1]);
      }
      function closeNav(){
        body.classList.remove('nav-open');
        aside.setAttribute('aria-hidden','true');
        btnMenu.setAttribute('aria-expanded','false');
        stack=[root];
        show(root);
        if(lastFocused) lastFocused.focus();
      }

      aside.addEventListener('click', (e)=>{
        const next = e.target.closest('.nav-next');
        if(next){
          const sel = next.getAttribute('data-target');
          const target = aside.querySelector(sel);
          if(!target){ alert('Панель не найдена: '+sel); return; }
          stack.push(target);
          show(target);
          return;
        }
        if(e.target.closest('.nav-close') || e.target.closest('[data-close]')) closeNav();
      });

      btnBack.addEventListener('click', ()=>{
        if(stack.length>1){
          stack.pop();
          show(stack[stack.length-1]);
        }
      });

      btnMenu.addEventListener('click', openNav);
      btnClose.addEventListener('click', closeNav);
      overlay.addEventListener('click', closeNav);

      document.addEventListener('keydown', (e)=>{
        if(e.key==='Escape' && body.classList.contains('nav-open')) closeNav();
      });

      // Init: hide all except root (safety in case CSS stripped)
      panels.forEach(p=> p.hidden = true);
      root.hidden = false;
    })();
  </script>
</body>
</html>
